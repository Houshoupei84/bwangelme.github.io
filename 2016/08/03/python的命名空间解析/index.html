<!DOCTYPE html>
<html lang="zh-Hans">
<head>

  <meta charset="utf-8" />

  
  <title>Python的命名空间解析</title>

  
  





  
  <meta name="author" content="BWANGEL" />
  <meta name="description" content="摘要:
  什么是命名空间 命名空间有哪些 变量查找原则 分析一个UnboundLocalError的例子   
" />

  
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@gohugoio" />
    <meta name="twitter:title" content="Python的命名空间解析" />
    <meta name="twitter:description" content="摘要:
  什么是命名空间 命名空间有哪些 变量查找原则 分析一个UnboundLocalError的例子   
" />
    <meta name="twitter:image" content="/img/avatar.jpg" />
  

  
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Python的命名空间解析" />
  <meta property="og:description" content="摘要:
  什么是命名空间 命名空间有哪些 变量查找原则 分析一个UnboundLocalError的例子   
" />
  <meta property="og:url" content="/2016/08/03/python%E7%9A%84%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%A7%A3%E6%9E%90/" />
  <meta property="og:image" content="/img/avatar.jpg" />




<meta name="generator" content="Hugo 0.40.3" />


<link rel="canonical" href="/2016/08/03/python%E7%9A%84%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%A7%A3%E6%9E%90/" />

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />







<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Keep Foolish" />
<meta name="msapplication-tooltip" content="Keep Foolish" />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="/img/touch-icon-apple.png" />
<link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="/css/bundle.bfaa7ffd11.css" />


  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
        <a title="Go to comments" class="to-comment" href="#gitment-container"><span class="icon icon-comment"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="/img/avatar.jpg" alt="Avatar">
  
  <h2 class="title">Keep Foolish</h2>
  
  <p class="subtitle">闻道百，以为莫己若者，我之谓也。</p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
            
            
            
              is-active
            ">
            <a href="/">首页</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="/tags">标签</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="/about/">关于</a>
          </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      
      <li class="social-item">
        <a href="mailto:bwangel.me@gmail.com" title="Email"><span class="icon icon-email"></span></a>
      </li>

      
      <li class="social-item">
        <a href="//github.com/bwangelme" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a rel="alternate" type="application/rss+xml" href="/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">Python的命名空间解析</h1>
      <p class="post-meta">@BWANGEL · 发表于 2016年8月3日 · 2 min read</p>
    </header>
    <article class="post-content"><p><strong>摘要</strong>:</p>

<blockquote>
<ol>
<li>什么是命名空间</li>
<li>命名空间有哪些</li>
<li>变量查找原则</li>
<li>分析一个UnboundLocalError的例子</li>
</ol>
</blockquote>

<p></p>

<h2 id="什么是命名空间">什么是命名空间</h2>

<p>首先说什么是命名空间呢！我们知道，在Python中，一切都是对象，然后通过<strong>名字</strong>去引用对象。例如我们执行了一条语句<code>a = 3</code>,Python做的工作就是让名字<code>a</code>去引用一个 Int 对象<code>3</code>。这种名字和对象的对应关系都存储在一个字典中，而这个字典，就叫做命名空间。任何一个模块，类，实例，函数，都有其命名空间，这个命名空间可以通过<code>__dict__</code>来访问。比如下面这段代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">is</span> <span class="nb">globals</span><span class="p">())</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="mi">32</span></code></pre></div>
<p>在上面的例子中，我们首先通过<code>sys.modules</code>获取了当前运行的模块，然后通过<code>__dict__</code>成员获取了当前模块的命名空间，然后发现<code>globals</code>函数返回的就是当前模块的命名空间。当我们执行了<code>a = 3</code>语句以后，可以看到，当前模块的命名空间中多了一个<code>a</code>成员，其值为3。</p>

<h2 id="命名空间有哪些">命名空间有哪些</h2>

<p>前面我们讲到，每个类，函数，实例，模块都有其命名空间，可以通过<code>__dict__</code>成员来访问，如下面代码所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">main_module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">module_member</span> <span class="o">=</span> <span class="s1">&#39;module&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">C</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">class_member</span> <span class="o">=</span> <span class="s1">&#39;class&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">instance_member</span> <span class="o">=</span> <span class="s1">&#39;instance&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
<span class="o">...</span>     <span class="n">func_member</span> <span class="o">=</span> <span class="s1">&#39;function&#39;</span>
<span class="o">...</span>     <span class="n">fls</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">f_locals</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="s1">&#39;fls and locals() are same object? </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fls</span> <span class="ow">is</span> <span class="nb">locals</span><span class="p">()))</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">fls</span><span class="p">[</span><span class="s1">&#39;func_member&#39;</span><span class="p">])</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">main_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;module_member&#39;</span><span class="p">])</span>
<span class="n">module</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;class_member&#39;</span><span class="p">])</span>
<span class="k">class</span>
<span class="err">&gt;&gt;&gt; </span><span class="nc">print</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;instance_member&#39;</span><span class="p">])</span>
<span class="n">instance</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">func</span><span class="p">()</span>
<span class="n">fls</span> <span class="ow">and</span> <span class="nb">locals</span><span class="p">()</span> <span class="n">are</span> <span class="n">same</span> <span class="nb">object</span><span class="err">?</span> <span class="bp">True</span>
<span class="n">function</span></code></pre></div>
<p>在上面的代码中，我们分别访问了，模块，类，实例，函数的命名空间，并在其中取出了我们命名的变量。其中，访问函数的命名空间有些特殊，我们是通过<code>_getframe</code>函数访问了当前栈帧，然后在栈帧中找到了当前函数的命名空间。当然这个函数的命名空间也可以通过<code>locals</code>函数访问到。</p>

<h2 id="变量查找原则">变量查找原则</h2>

<p>从上面的例子中，我们了解到，命名空间其实就是存储名字和对象的对应关系的，那么当我们通过一个名字来获取一个对象的时候，其查找命名空间的顺序是怎样的呢？在Python中遵循着<strong>LEGB</strong>的查找原则。</p>

<p>LEGB的意思就是<code>Local -&gt; Enclosing Function -&gt; Global -&gt; Builtins</code>。</p>

<p>遇到一个名字的时候，Python解释器首先会去本地命名空间(<code>Local</code>)中查找，然后再去其所在函数的作用域(<code>Enclosing Function</code>)中查找，如果还没找到，就去全局命名空间(<code>Global</code>)中查找，最后会去<code>__builtin__</code>这个模块中查找，<code>__builtin__</code>模块在 Python3 中已经重命名成了<code>builtins</code>，详见 <a href="http://stackoverflow.com/questions/9047745/where-is-the-builtin-module-in-python3-why-was-it-renamed">stackoverflow 上关于<code>builtin</code>的提问</a>，感谢<a href="https://gold.xitu.io/entry/5859fdb3570c3500691df8de/detail">@欧阳杰</a>童鞋指出这个问题。</p>

<p>例如下面的一段代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1234</span>
<span class="o">...</span> <span class="n">__builtin__</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;Hello, World!&#39;</span>
<span class="o">...</span> <span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
<span class="o">...</span>     <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span> <span class="n">test</span><span class="p">()</span>
<span class="o">...</span>
<span class="mi">1234</span>
<span class="n">abc</span>
<span class="n">Hello</span><span class="p">,</span> <span class="n">World</span><span class="err">!</span></code></pre></div>
<p>在上面的代码中，s 是<code>builtins</code>命名空间中的名字，y 是<code>local</code>命名空间中的名字，x 是<code>Global</code>命名空间中的名字，它们都能够被正确找到并打印出来。</p>

<h2 id="分析一个unboundlocalerror例子">分析一个UnboundLocalError例子</h2>

<p>在最后，我们来分析这样一段代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">x</span> <span class="o">=</span> <span class="mi">1234</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span>

<span class="n">test</span><span class="p">()</span></code></pre></div>
<pre><code>---------------------------------------------------------------------------

UnboundLocalError                         Traceback (most recent call last)

&lt;ipython-input-45-9f45a812fe7a&gt; in &lt;module&gt;()
      4     x = 'abc'
      5
----&gt; 6 test()


&lt;ipython-input-45-9f45a812fe7a&gt; in test()
      1 x = 1234
      2 def test():
----&gt; 3     print(x)
      4     x = 'abc'
      5


UnboundLocalError: local variable 'x' referenced before assignment
</code></pre>

<p>在上面的函数中，我们要打印一个名字<code>x</code>，它首先会去本地命名空间中查找，没有找到。然后去当前函数<code>test</code>的作用域中查找，找到了。此时Python解释器就会发现<code>x</code>这个名字还没有添加到local本地命名空间中，就被引用了。所以就会抛出一个异常，说<code>x</code>还未被赋值就被引用了。如果我们把代码改成下面这种形式，发现就可以正常运行了：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">x</span> <span class="o">=</span> <span class="mi">1234</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">test</span><span class="p">()</span></code></pre></div>
<pre><code>1234
</code></pre>

<p>为什么删除了x的赋值语句，这个函数就能正常运行了呢？
这是因为此时Python解释器查找命名空间的顺序变了。解释器首先会去查找本地命名空间，发现没有，然后去查找函数<code>test</code>的作用域，发现也没有，接着再去查找全局命名空间，此时找到了，就会打印出x的值。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">dis</span>

<span class="n">x</span> <span class="o">=</span> <span class="mi">1234</span>
<span class="k">def</span> <span class="nf">test_right</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">test_right</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="mi">1234</span>
<span class="k">def</span> <span class="nf">test_error</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span>

<span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">test_error</span><span class="p">)</span></code></pre></div>
<pre><code>  5           0 LOAD_GLOBAL              0 (print)
              3 LOAD_GLOBAL              1 (x)
              6 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
              9 POP_TOP
             10 LOAD_CONST               0 (None)
             13 RETURN_VALUE
--------------------
 13           0 LOAD_GLOBAL              0 (print)
              3 LOAD_FAST                0 (x)
              6 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
              9 POP_TOP

 14          10 LOAD_CONST               1 ('abc')
             13 STORE_FAST               0 (x)
             16 LOAD_CONST               0 (None)
             19 RETURN_VALUE
</code></pre>

<p>通过查看这两个函数的反汇编出来的代码可以看到，这两个函数访问x的时候，一个是通过<code>LOAD_GLOBAL</code>指令，访问的全局命名空间，另外一个则是通过<code>LOAD_FAST</code>指令访问的本地命名空间。通过这些反汇编出来的代码，可以部分地证明我们上面的猜想。</p></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="/tags/python"><span class="tag">Python</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        本博客所有文章除特别声明外，均采用 <a href='http://creativecommons.org/licenses/by-nc-sa/3.0/cn/' rel='external nofollow' target='_blank'>CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！
      </p>
    </footer>
    
      <div id="gitment-container"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
  (function() {
    var page_url = decodeURI("/2016/08/03/python%E7%9A%84%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%A7%A3%E6%9E%90/");
    var page_uniqueid = "caeb6efc99472a679006e40b2d0b36ef";

    if (page_url.length >= 50) {
      console.log("文章的路径", "[" + page_url + "]:" + page_url.length, "超过了50个字符，使用 UniqueID 设置评论ID");
      comment_id = page_uniqueid
    } else {
      comment_id = page_url
    }

    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      console.log(comment_id, comment_id.length);
      document.getElementById('gitment-container').innerHTML = 'Gitment comments not available by default when the website is previewed locally.';
    } else {
      var gitment = new Gitment({
        id: comment_id,
        owner: "bwangelme",
        repo: "blog-comment",
        oauth: {
          client_id: "57954aa9925858cd8b32",
          client_secret: "1bfbecbae2fe6a1d288a56198b112cf44912cec7",
        },
      })
      gitment.render('gitment-container');
    }
  })();
</script>

      
    
  </section>
  <footer class="site-footer">
  <p>© 2017-2018 Keep Foolish</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="/js/bundle.4830e45d80.js"></script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-89788711-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>





  </body>
</html>
