<!DOCTYPE html>
<html lang="zh-Hans">
<head>

  <meta charset="utf-8" />

  
  <title>Python的命名空间解析</title>

  
  
<link href="//cdn.jsdelivr.net" rel="dns-prefetch">
<link href="//at.alicdn.com" rel="dns-prefetch">
<link href="//fonts.googleapis.com" rel="dns-prefetch">
<link href="//fonts.gstatic.com" rel="dns-prefetch">



<link href="//www.google-analytics.com" rel="dns-prefetch">






<meta name="description" content="摘要:
  什么是命名空间 命名空间有哪些 变量查找原则 分析一个UnboundLocalError的例子  ">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@gohugoio">
<meta name="twitter:title" content="Python的命名空间解析">
<meta name="twitter:description" content="摘要:
  什么是命名空间 命名空间有哪些 变量查找原则 分析一个UnboundLocalError的例子  ">
<meta name="twitter:image" content="/images/avatar.jpg">



<meta property="og:type" content="article">
<meta property="og:title" content="Python的命名空间解析">
<meta property="og:description" content="摘要:
  什么是命名空间 命名空间有哪些 变量查找原则 分析一个UnboundLocalError的例子  ">
<meta property="og:url" content="/2016/08/03/python%E7%9A%84%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%A7%A3%E6%9E%90/">
<meta property="og:image" content="/images/avatar.jpg">




<meta name="generator" content="Hugo 0.51">


<link rel="canonical" href="/2016/08/03/python%E7%9A%84%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%A7%A3%E6%9E%90/">

<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="format-detection" content="telephone=no,email=no,adress=no">
<meta http-equiv="Cache-Control" content="no-transform">


<meta name="robots" content="index,follow">
<meta name="referrer" content="origin-when-cross-origin">







<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Keep Foolish">
<meta name="msapplication-tooltip" content="Keep Foolish">
<meta name='msapplication-navbutton-color' content="#5fbf5e">
<meta name="msapplication-TileColor" content="#5fbf5e">
<meta name="msapplication-TileImage" content="/images/tile-image-windows.png">
<link rel="icon" href="/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" sizes="192x192" href="/images/touch-icon-android.png">
<link rel="apple-touch-icon" href="/images/touch-icon-apple.png">


<link rel="preload" href="/styles/main.min.css" as="style">
<link rel="preload" href="https://fonts.googleapis.com/css?family=Lobster" as="style">
<link rel="preload" href="/images/avatar.jpg" as="image">
<link rel="preload" href="/images/grey-prism.svg" as="image">


<style>
  body {
    background: rgb(244, 243, 241) url('/images/grey-prism.svg') repeat fixed;
  }
</style>
<link rel="stylesheet" href="/styles/main.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video-js.min.css">


  
  
<!--[if lte IE 8]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ie8@1.1.2/dist/videojs-ie8.min.js"></script>
<![endif]-->

<!--[if lte IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20180112/classList.min.js"></script>
<![endif]-->


<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@14.2.1/dist/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="/images/avatar.jpg" alt="Avatar">
  
  <h2 class="title">Keep Foolish</h2>
  
  <p class="subtitle">闻道百，以为莫己若者，我之谓也。</p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
            
            
            
              is-active
            ">
            <a href="/">首页</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="/tags">标签</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="/about/">关于</a>
          </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list"><li class="social-item"><a href="mailto:bwangel.me@gmail.com" title="Email"><span class="icon icon-email"></span></a></li><li class="social-item"><a href="//github.com/bwangelme" title="GitHub"><span class="icon icon-github"></span></a></li><li class="social-item"><a href="//weibo.com/3093227873" title="Weibo"><span class="icon icon-weibo"></span></a></li></ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">Python的命名空间解析</h1>
      <p class="post-meta">@BWANGEL · 发表于 2016年8月3日 · 2 min read</p>
    </header>
    <article class="post-content"><p><strong>摘要</strong>:</p>

<blockquote>
<ol>
<li>什么是命名空间</li>
<li>命名空间有哪些</li>
<li>变量查找原则</li>
<li>分析一个UnboundLocalError的例子</li>
</ol>
</blockquote>

<h2 id="什么是命名空间">什么是命名空间</h2>

<p>首先说什么是命名空间呢！我们知道，在Python中，一切都是对象，然后通过<strong>名字</strong>去引用对象。例如我们执行了一条语句<code>a = 3</code>,Python做的工作就是让名字<code>a</code>去引用一个 Int 对象<code>3</code>。这种名字和对象的对应关系都存储在一个字典中，而这个字典，就叫做命名空间。任何一个模块，类，实例，函数，都有其命名空间，这个命名空间可以通过<code>__dict__</code>来访问。比如下面这段代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> sys
<span style="color:#f92672">&gt;&gt;&gt;</span> m <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>modules[__name__]
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">print</span>(m<span style="color:#f92672">.</span>__dict__ <span style="color:#f92672">is</span> globals())
True
<span style="color:#f92672">&gt;&gt;&gt;</span> a <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> globals()<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;a&#39;</span>)
<span style="color:#ae81ff">32</span></code></pre></div>
<p>在上面的例子中，我们首先通过<code>sys.modules</code>获取了当前运行的模块，然后通过<code>__dict__</code>成员获取了当前模块的命名空间，然后发现<code>globals</code>函数返回的就是当前模块的命名空间。当我们执行了<code>a = 3</code>语句以后，可以看到，当前模块的命名空间中多了一个<code>a</code>成员，其值为3。</p>

<h2 id="命名空间有哪些">命名空间有哪些</h2>

<p>前面我们讲到，每个类，函数，实例，模块都有其命名空间，可以通过<code>__dict__</code>成员来访问，如下面代码所示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> sys
<span style="color:#f92672">&gt;&gt;&gt;</span> main_module <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>modules[__name__]
<span style="color:#f92672">&gt;&gt;&gt;</span> module_member <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;module&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">C</span>:
<span style="color:#f92672">...</span>     class_member <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;class&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> c <span style="color:#f92672">=</span> C()
<span style="color:#f92672">&gt;&gt;&gt;</span> c<span style="color:#f92672">.</span>instance_member <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;instance&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">func</span>():
<span style="color:#f92672">...</span>     func_member <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;function&#39;</span>
<span style="color:#f92672">...</span>     fls <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>_getframe(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>f_locals
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;fls and locals() are same object? </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> (fls <span style="color:#f92672">is</span> locals()))
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(fls[<span style="color:#e6db74">&#39;func_member&#39;</span>])
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">print</span>(main_module<span style="color:#f92672">.</span>__dict__[<span style="color:#e6db74">&#39;module_member&#39;</span>])
module
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">print</span>(C<span style="color:#f92672">.</span>__dict__[<span style="color:#e6db74">&#39;class_member&#39;</span>])
<span style="color:#66d9ef">class</span>
<span style="color:#960050;background-color:#1e0010">&gt;&gt;&gt; </span><span style="color:#a6e22e">print</span>(c<span style="color:#f92672">.</span>__dict__[<span style="color:#e6db74">&#39;instance_member&#39;</span>])
instance
<span style="color:#f92672">&gt;&gt;&gt;</span> func()
fls <span style="color:#f92672">and</span> locals() are same object<span style="color:#960050;background-color:#1e0010">?</span> True
function</code></pre></div>
<p>在上面的代码中，我们分别访问了，模块，类，实例，函数的命名空间，并在其中取出了我们命名的变量。其中，访问函数的命名空间有些特殊，我们是通过<code>_getframe</code>函数访问了当前栈帧，然后在栈帧中找到了当前函数的命名空间。当然这个函数的命名空间也可以通过<code>locals</code>函数访问到。</p>

<h2 id="变量查找原则">变量查找原则</h2>

<p>从上面的例子中，我们了解到，命名空间其实就是存储名字和对象的对应关系的，那么当我们通过一个名字来获取一个对象的时候，其查找命名空间的顺序是怎样的呢？在Python中遵循着<strong>LEGB</strong>的查找原则。</p>

<p>LEGB的意思就是<code>Local -&gt; Enclosing Function -&gt; Global -&gt; Builtins</code>。</p>

<p>遇到一个名字的时候，Python解释器首先会去本地命名空间(<code>Local</code>)中查找，然后再去其所在函数的作用域(<code>Enclosing Function</code>)中查找，如果还没找到，就去全局命名空间(<code>Global</code>)中查找，最后会去<code>__builtin__</code>这个模块中查找，<code>__builtin__</code>模块在 Python3 中已经重命名成了<code>builtins</code>，详见 <a href="http://stackoverflow.com/questions/9047745/where-is-the-builtin-module-in-python3-why-was-it-renamed">stackoverflow 上关于<code>builtin</code>的提问</a>，感谢<a href="https://gold.xitu.io/entry/5859fdb3570c3500691df8de/detail">@欧阳杰</a>童鞋指出这个问题。</p>

<p>例如下面的一段代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1234</span>
<span style="color:#f92672">...</span> __builtin__<span style="color:#f92672">.</span>s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Hello, World!&#39;</span>
<span style="color:#f92672">...</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>():
<span style="color:#f92672">...</span>     y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;abc&#39;</span>
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(x)
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(y)
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(s)
<span style="color:#f92672">...</span>
<span style="color:#f92672">...</span> test()
<span style="color:#f92672">...</span>
<span style="color:#ae81ff">1234</span>
abc
Hello, World<span style="color:#960050;background-color:#1e0010">!</span></code></pre></div>
<p>在上面的代码中，s 是<code>builtins</code>命名空间中的名字，y 是<code>local</code>命名空间中的名字，x 是<code>Global</code>命名空间中的名字，它们都能够被正确找到并打印出来。</p>

<h2 id="分析一个unboundlocalerror例子">分析一个UnboundLocalError例子</h2>

<p>在最后，我们来分析这样一段代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1234</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>():
    <span style="color:#66d9ef">print</span>(x)
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;abc&#39;</span>

test()</code></pre></div>
<pre><code>---------------------------------------------------------------------------

UnboundLocalError                         Traceback (most recent call last)

&lt;ipython-input-45-9f45a812fe7a&gt; in &lt;module&gt;()
      4     x = 'abc'
      5
----&gt; 6 test()


&lt;ipython-input-45-9f45a812fe7a&gt; in test()
      1 x = 1234
      2 def test():
----&gt; 3     print(x)
      4     x = 'abc'
      5


UnboundLocalError: local variable 'x' referenced before assignment
</code></pre>

<p>在上面的函数中，我们要打印一个名字<code>x</code>，它首先会去本地命名空间中查找，没有找到。然后去当前函数<code>test</code>的作用域中查找，找到了。此时Python解释器就会发现<code>x</code>这个名字还没有添加到local本地命名空间中，就被引用了。所以就会抛出一个异常，说<code>x</code>还未被赋值就被引用了。如果我们把代码改成下面这种形式，发现就可以正常运行了：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1234</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>():
    <span style="color:#66d9ef">print</span>(x)

test()</code></pre></div>
<pre><code>1234
</code></pre>

<p>为什么删除了x的赋值语句，这个函数就能正常运行了呢？
这是因为此时Python解释器查找命名空间的顺序变了。解释器首先会去查找本地命名空间，发现没有，然后去查找函数<code>test</code>的作用域，发现也没有，接着再去查找全局命名空间，此时找到了，就会打印出x的值。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> dis

x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1234</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_right</span>():
    <span style="color:#66d9ef">print</span>(x)

dis<span style="color:#f92672">.</span>dis(test_right)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">20</span>)

x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1234</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_error</span>():
    <span style="color:#66d9ef">print</span>(x)
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;abc&#39;</span>

dis<span style="color:#f92672">.</span>dis(test_error)</code></pre></div>
<pre><code>  5           0 LOAD_GLOBAL              0 (print)
              3 LOAD_GLOBAL              1 (x)
              6 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
              9 POP_TOP
             10 LOAD_CONST               0 (None)
             13 RETURN_VALUE
--------------------
 13           0 LOAD_GLOBAL              0 (print)
              3 LOAD_FAST                0 (x)
              6 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
              9 POP_TOP

 14          10 LOAD_CONST               1 ('abc')
             13 STORE_FAST               0 (x)
             16 LOAD_CONST               0 (None)
             19 RETURN_VALUE
</code></pre>

<p>通过查看这两个函数的反汇编出来的代码可以看到，这两个函数访问x的时候，一个是通过<code>LOAD_GLOBAL</code>指令，访问的全局命名空间，另外一个则是通过<code>LOAD_FAST</code>指令访问的本地命名空间。通过这些反汇编出来的代码，可以部分地证明我们上面的猜想。</p></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="/tags/python"><span class="tag">Python</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        本博客所有文章除特别声明外，均采用 <a href='http://creativecommons.org/licenses/by-nc-sa/3.0/cn/' rel='external nofollow' target='_blank'>CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！
      </p>
    </footer>
    
      <script src="https://utteranc.es/client.js"
        repo="bwangelme/blog-comment"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
      
    
  </section>
  


<footer class="site-footer">
  <p>© 2017-2018 Keep Foolish</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo"
      target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video.min.js"></script>




<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>



<script src="/scripts/index.min.js"></script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-89788711-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






  </body>
</html>
